<%= form_for [attachment.lesson, attachment], html: {multipart: true,  class: "form-horizontal center", role: "form" } do |f|%>
    <%= render 'shared/error_messages', object: f.object %>
    <div class="form-group">
      <%=f.label :description, class: "col-sm-2 control-label"%>
      <div class="col-sm-10">
        <%=f.text_area :description, class: "form-control"%>
      </div>
    </div>
    <div class="form-group">
        <%=f.label :file, class: "col-sm-2 control-label" %>
        <div class="col-sm-10">
            <%= f.file_field :file, class: "form-control attachment-upload" %>
        </div>
    </div>
    <div class="form-group">
      <div class="col-sm-offset-2 col-sm-10">
        <%= f.submit "Загрузить файл", class: "btn btn-large btn-primary upload-button" %>
      </div>
    </div>
    <!-- The global progress bar -->
    <div class="progress">
      <div class="progress-bar" role="progressbar"></div>
    </div>
<% end %>
<script>
    /*jslint unparam: true */
    /*global window, $ */
    $(function () {
        var submit = $("#new_attachment input:submit.upload-button").prop('disabled',true);
        var uploadObj = $('.attachment-upload').fileupload({
            autoUpload: false,
            url: $(this).closest('form').attr('action'),
            dataType: 'json',
            add: function (e, data) {
                submit
                    .prop('disabled', false)
                    .off('click')
                    .on('click', function () {
                        data.submit();
                        return false;
                    });
            },
            fail: function(e, data) {
                var progressBar = $(this).closest('form').find('.progress-bar');
                progressBar.css('width', '0%');
                var errors = new Array();
                for(var prop in data.jqXHR.responseJSON) {
                    for(var i = 0; i < data.jqXHR.responseJSON[prop].length; i++) {
                        errors[i] = data.jqXHR.responseJSON[prop][i];
                    }
                }

                var form = $(this).closest('form');
                FormUtils.show_errors(form, errors);
            },
            done: function (e, data) {
                $.getScript(data.result.update_path);
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                var progressBar = $(this).closest('form').find('.progress-bar');
                progressBar.css('width', progress + '%');
            }
        });
    });
</script>